name: 每日AI新闻简报（Minimax）

on:
  schedule:
    - cron: '0 0 * * *'  # 北京时间 每天 8:00
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 安装工具
        run: sudo apt-get update && sudo apt-get install -y curl jq

      - name: 获取AI新闻
        id: get_news
        run: |
          API_KEY="sk-api-g_fL1Sz_Ht6gWJxqdvlMkCzkzfg0HrJCjHmBxXHs5y8je5R2Hz9TD9FoGhFvKLSv-rKuq5gJsDwwzcuSF4O5eWbdEQ635tkM7pgVi7QAybca9tIsW9XsPmw"
          GROUP_ID="2025760618228753282"

          echo "正在调用 Minimax API..."
          RESULT=$(curl -s "https://api.minimax.chat/v1/chat/completions" \
            -H "Authorization: Bearer $API_KEY" \
            -H "Content-Type: application/json" \
            -H "GroupId: $GROUP_ID" \
            -d '{
              "model": "MiniMax-M2.1",
              "messages": [
                {
                  "role": "user",
                  "content": "请直接生成5条关于Agent、MCP、大模型的AI行业简报，每条标注日期，不要使用工具调用或思考过程。"
                }
              ],
              "temperature": 0.2,
              "max_tokens": 500,
              "stream": false
            }')

          echo "API 原始响应: $RESULT"

          # 使用更安全的方式解析并转义内容
          if echo "$RESULT" | jq -e '.choices[0].message.content' > /dev/null; then
            # 使用jq的@json函数转义特殊字符
            CONTENT=$(echo "$RESULT" | jq -r '.choices[0].message.content | @json')
            # 移除外层引号
            CONTENT="${CONTENT%\"}"
            CONTENT="${CONTENT#\"}"
          elif echo "$RESULT" | jq -e '.error' > /dev/null; then
            CONTENT="API 调用失败，错误: $(echo "$RESULT" | jq -r '.error.message')"
          else
            CONTENT="API 返回格式异常"
          fi

          # 使用EOF避免特殊字符问题
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 输出内容（自动发GitHub邮件）
        run: echo "${{ steps.get_news.outputs.content }}"
